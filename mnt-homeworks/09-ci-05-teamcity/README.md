# Домашнее задание к занятию "11.Teamcity"

## Подготовка к выполнению

1. В Ya.Cloud создайте новый инстанс (4CPU4RAM) на основе образа `jetbrains/teamcity-server`
2. Дождитесь запуска teamcity, выполните первоначальную настройку
3. Создайте ещё один инстанс(2CPU4RAM) на основе образа `jetbrains/teamcity-agent`. Пропишите к нему переменную окружения `SERVER_URL: "http://<teamcity_url>:8111"`
4. Авторизуйте агент

Агент авторизован
![Агент авторизован](./src/agent.png "Агент авторизован")

5. Сделайте fork [репозитория](https://github.com/aragastmatb/example-teamcity)
6. Создать VM (2CPU4RAM) и запустить [playbook](./infrastructure)

## Основная часть

1. Создайте новый проект в teamcity на основе fork

Создан новый проект
![Проект](./src/project.png "Проект")

2. Сделайте autodetect конфигурации

Создана конфигурация

![Конфигурация](./src/config.png "Конфигурация")

![Автодектект конфигурации](./src/autodetect.png "Автодектект конфигурации")

3. Сохраните необходимые шаги, запустите первую сборку master'a

Первая сборка master

![Первая сборка master](./src/build1.png "Первая сборка master")

4. Поменяйте условия сборки: если сборка по ветке `master`, то должен происходит `mvn clean deploy`, иначе `mvn clean test`

Настроены условия сборки

![Условия сборки](./src/build_master.png "Условия сборки")

5. Для deploy будет необходимо загрузить [settings.xml](./teamcity/settings.xml) в набор конфигураций maven у teamcity, предварительно записав туда креды для подключения к nexus
6. В pom.xml необходимо поменять ссылки на репозиторий и nexus
7. Запустите сборку по master, убедитесь что всё прошло успешно, артефакт появился в nexus

Новая сборка master

![Вторая сборка master](./src/build_master.png "Вторая сборка master")

![Артефакт в nexus](./src/nexus.png "Артефакт в nexus")

8. Мигрируйте `build configuration` в репозиторий

Настроено сохранение конфигурации в репозиторий

![Сохранение конфигурации в репозиторий](./src/sync.png "Сохранение конфигурации в репозиторий")

9. Создайте отдельную ветку `feature/add_reply` в репозитории

Создана новая ветка

![Создана новая ветка](./src/branch.png "Создана новая ветка")

10. Напишите новый метод для класса Welcomer: метод должен возвращать произвольную реплику, содержащую слово `hunter`
11. Дополните тест для нового метода на поиск слова `hunter` в новой реплике
12. Сделайте push всех изменений в новую ветку в репозиторий
13. Убедитесь что сборка самостоятельно запустилась, тесты прошли успешно

Сборка запустилась

![Сборка из новой ветки](./src/build_branch.png "Сборка из новой ветки")

14. Внесите изменения из произвольной ветки `feature/add_reply` в `master` через `Merge`

Изменения внесены

![Merge новой ветки](./src/merge1.png "Merge новой ветки")

![Сборка master](./src/build_master2.png "Сборка master")

15. Убедитесь, что нет собранного артефакта в сборке по ветке `master`

Артефакты не появились

![Артефакты](./src/noart.png "Артефакты")

16. Настройте конфигурацию так, чтобы она собирала `.jar` в артефакты сборки

Настроена сборка артефактов

![Сборка артефактов](./src/art_set.png "Сборка артефактов")

17. Проведите повторную сборку мастера, убедитесь, что сбора прошла успешно и артефакты собраны

Сборка master

![Сборка master](./src/build_master3.png "Сборка master")

![Артефакты](./src/art.png "Артефакты")

18. Проверьте, что конфигурация в репозитории содержит все настройки конфигурации из teamcity
19. В ответ предоставьте ссылку на репозиторий

[Репозиторий с конфигурацией teamcity](https://github.com/kmv879/example-teamcity.git)

---
